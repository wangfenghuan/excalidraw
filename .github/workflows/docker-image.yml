name: Build Excalidraw Docker Image

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  # 允许手动触发工作流
  workflow_dispatch:

env:
  # 使用 GitHub 官方容器仓库 (GHCR)
  REGISTRY: ghcr.io
  # 镜像名称默认为：用户名/仓库名 (例如: wangfenghuan/excalidraw)
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    #以此配置赋予 GITHUB_TOKEN 推送镜像包的权限
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 设置 Docker Buildx (用于构建缓存和多平台构建)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. 登录到 GitHub Container Registry
      # 注意：如果是 Pull Request，通常只构建不推送，但在本示例中配置为均登录
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. 提取元数据 (用于生成 tags 和 labels)
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          # 自动生成 tags:
          # - type=raw: 如果是主分支，标记为 latest
          # - type=sha: 附加短 commit hash (例如: sha-8f3e2a1)
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=short

      # 5. 构建并推送镜像
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          # 如果是 PR，只构建不推送；如果是 Push 或手动触发，则推送
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # 启用缓存以加快二次构建速度
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # 针对 Excalidraw 等 Node 项目的常见构建参数
          build-args: |
            NODE_ENV=production
